# ebpf-wg-quic-differentiator

Building on [wg-quic-differentiator](https://github.com/zegevlier/wg-quic-differentiator), I wanted to try create an eBPF program that does the same thing. This program uses eBPF to rewrite any packets incoming on a specified interface and QUIC port to a specified WireGuard port, and likewise for outgoing packets.

It uses the same [heuristic](https://github.com/zegevlier/wg-quic-differentiator#how-it-works) as wg-quic-differentiator. Just like that one, this program is not guaranteed to be production ready. Use at your own risk.

The main interesting function is in `ebpf-wg-quic-differentiator-ebpf/src/main.rs`, [`try_ebpf_wg_quic_differentiator`](ebpf-wg-quic-differentiator-ebpf/src/main.rs#L41-L132). This function is called for every packet on the specified interface, and does the heuristic check and port rewriting.

Now follows mostly the standard README generated by Aya (the eBPF framework for Rust), with some modifications to reflect the arguments of this program, and removing some unnecessary information about cross compiling.

## Prerequisites

1. stable rust toolchains: `rustup toolchain install stable`
1. nightly rust toolchains: `rustup toolchain install nightly --component rust-src`
1. bpf-linker: `cargo install bpf-linker` (`--no-default-features` on macOS)

## Build & Run

Use `cargo build`, `cargo check`, etc. as normal. Run your program with:

```shell
cargo run --release
```

By default, the program will run on `eth0`, with WireGuard port `51820` and QUIC port `443`. You can override these defaults with command line arguments:

```shell
cargo run --release -- --iface <INTERFACE> --wg-port <WIREGUARD_PORT> --quic-port <QUIC_PORT>
```

Cargo build scripts are used to automatically build the eBPF correctly and include it in the
program.

## License

With the exception of eBPF code, ebpf-wg-quic-differentiator is distributed under the terms
of either the [MIT license] or the [Apache License] (version 2.0), at your
option.

Unless you explicitly state otherwise, any contribution intentionally submitted
for inclusion in this crate by you, as defined in the Apache-2.0 license, shall
be dual licensed as above, without any additional terms or conditions.

### eBPF

All eBPF code is distributed under either the terms of the
[GNU General Public License, Version 2] or the [MIT license], at your
option.

Unless you explicitly state otherwise, any contribution intentionally submitted
for inclusion in this project by you, as defined in the GPL-2 license, shall be
dual licensed as above, without any additional terms or conditions.

[Apache license]: LICENSE-APACHE
[MIT license]: LICENSE-MIT
[GNU General Public License, Version 2]: LICENSE-GPL2
